{% extends "tram/base.html" %}
{% block content %}
    <div class="card-panel white">
        <h1>{{asset.assetnummer}}</h1>
        <div class="row">
            <div class="col l5">
                <div class="card-panel blue-grey lighten-3">
                    <h3>Details</h3>
                    <table>
                        <tr>
                            <td>Beschrijving:</td>
                            <td>{{asset.beschrijving}}</td>
                        </tr>
                        <tr>
                            <td>IP-Adres:</td>
                            <td>{{asset.ip_adres}}</td>
                        </tr>
                        <tr>
                            <td>Online:</td>
                            <td>{{asset.online}}</td>
                        </tr>
                        <tr>
                            <td>Configuratie:</td>
                            <td>{{asset.configuratie.naam}}</td>
                        </tr>
                        <tr>
                            <td>Weging:</td>
                            <td>{{asset.weging}}x</td>
                        </tr>
                        <tr>
                            <td>Aantal omlopen:</td>
                            <td>Bak A: {{laatste_polling.omloop_a}}<br>Bak B: {{laatste_polling.omloop_b}}</td>
                        </tr>
                        <tr>
                            <td>Laatste data ontvangen op:</td>
                            <td>{{laatste_polling.tijdstip}}</td>
                        </tr>
                    </table>
                    <br>
                </div>
            </div>
            <div class="col l7">
                <div class="card-panel  red lighten-2">
                    <h3>Laatste storingen:</h3>
                    <table>
                        <tr>
                            <th>Storing</th>
                            <th>Omlopen</th>
                            <th>Tijdstip</th>
                        </tr>
                        {% for data in laatste_data|dictsortreversed:"tijdstip"%}
                            <tr>
                                <td>
                                {% for s in data.storing_beschrijving%}
                                {{s}}<br>
                                {% endfor%}
                                </td>
                                {% if data.omloop_b > 0 %}
                                    <td>A:{{data.omloop_a}} <br> B: {{data.omloop_b}}</td>
                                {% else %}
                                    <td>{{data.omloop_a}}</td>   
                                {% endif%}
                                <td>{{data.tijdstip}}</td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col l12">
                <div class="card-panel white">
                    <div class="row">
                        <div class="input-field col s6">
                            <input id="van_datum" type="text" class="datepicker">
                            <label for="van_datum">Vanaf datum</label>
                        </div>
                        <div class="input-field col s5">
                            <input id="tot_datum" type="text" class="datepicker">
                            <label for="tot_datum">Tot en met datum</label>
                        </div>
                    </div>
                    <div class="row">
                        <a onclick="getAjaxData(vandaagDate(), vandaagDate())" class="waves-effect waves-light btn grey round"><i class="material-icons right">add</i> vandaag</a>
                        <a onclick="getAjaxData(vorigeMaandDate(), vandaagDate())" class="waves-effect waves-light btn grey round"><i class="material-icons right">add</i> afgelopen maand</a>
                    </div>
                    <div id="grafiek" class="center-align">
                        <div id="loader" class="preloader-wrapper big active">
                                <div class="spinner-layer spinner-blue">
                                    <div class="circle-clipper left">
                                    <div class="circle"></div>
                                    </div><div class="gap-patch">
                                    <div class="circle"></div>
                                    </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                    </div>
                                </div>
                            
                                <div class="spinner-layer spinner-red">
                                    <div class="circle-clipper left">
                                    <div class="circle"></div>
                                    </div><div class="gap-patch">
                                    <div class="circle"></div>
                                    </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                    </div>
                                </div>
                            
                                <div class="spinner-layer spinner-yellow">
                                    <div class="circle-clipper left">
                                    <div class="circle"></div>
                                    </div><div class="gap-patch">
                                    <div class="circle"></div>
                                    </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                    </div>
                                </div>
                            
                                <div class="spinner-layer spinner-green">
                                    <div class="circle-clipper left">
                                    <div class="circle"></div>
                                    </div><div class="gap-patch">
                                    <div class="circle"></div>
                                    </div><div class="circle-clipper right">
                                    <div class="circle"></div>
                                    </div>
                                </div>
                            </div>
                        <canvas id="myChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script>
        var chart;
        $(document).ready(function(){
            $('#myChart').hide();
            $('#loader').hide();

            var vanDatumPicker = $('#van_datum').datepicker({
                maxDate: new Date(),
                format: "dd-mm-yyyy",
                onClose: function(){
                    getAjaxData()
                }
                });

            var totDatumPicker = $('#tot_datum').datepicker({
                maxDate: new Date(),
                defaultDate: new Date(),
                setDefaultDate: true,
                format: "dd-mm-yyyy",
                onClose: function(){
                    getAjaxData()
                }
            });
        });

        function maak_grafiek(labels, data){
            $('#myChart').show();
            $('#loader').hide();
            var ctx = document.getElementById('myChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Omlopen bak A',
                        data: data[0],
                        borderColor: 'rgb(135, 255, 221)',
                        fill: false
                    },
                    {
                        label: 'Omlopen bak B',
                        data: data[1],
                        borderColor: 'rgb(135, 235, 255)',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }

        function laadGrafiek(){
            $('#myChart').hide();
            $('#loader').show();
        }

        function getAjaxData(vanDatum=document.getElementById("van_datum").value, totDatum=document.getElementById("tot_datum").value){
            if (chart){
                chart.destroy()
            }
            $.ajax({
                method: "GET",
                url: "/tram/api/omlopen/{{asset.assetnummer}}/"+ vanDatum + "/" + totDatum,              
                success: function(response){
                    maak_grafiek(response.labels, response.data);
                },
                error: function(error_data){
                    console.log(error_data)
                },
                beforeSend: function(response){
                    laadGrafiek()
                }
            })
        }

        function vandaagDate(){
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!

            var yyyy = today.getFullYear();
            if (dd < 10) {
            dd = '0' + dd;
            } 
            if (mm < 10) {
            mm = '0' + mm;
            } 
            var today = dd + '-' + mm + '-' + yyyy;
            return today;  
        }

        function vorigeMaandDate(){
            var today = new Date();
            var dd = today.getDate();
            var mm
            if ( today.getMonth() == 0)  { mm = 12} else { mm = today.getMonth()} 

            var yyyy = today.getFullYear();
            if (dd < 10) {
            dd = '0' + dd;
            } 
            if (mm < 10) {
            mm = '0' + mm;
            } 
            var today = dd + '-' + mm + '-' + yyyy;
            return today;  
    }

    </script>
{% endblock %}