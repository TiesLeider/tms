{% extends "tram/base.html" %}
{% block content %}
    <div class="card-panel white">
        <form class="col s12">
            <div class="row">
                <div class="input-field col s3">
                    <i id="zbIcon" class="material-icons prefix zoekBalkClass">search</i>
                    <input id="zoekBalk" type="text" class="validate zoekBalkClass">
                    <label for="zoekBalk">Zoeken</label>
                </div>
                <div class="col s9">
                    <div id="balk" class="progress grey lighten-4" style="margin-top: 30px;">
                        <div id="afteller" class="determinate" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </form>
        <table id="tabel">
            <tr>
                <th style="max-width: 5px;"></th>
                <th>ID</th>
                <th>Assetnummer</th>
                <th>Storing</th>
                <th>Count</th>
                <th>Score</th>
                <th>Omlopen</th>
                <th>Tijdstip</th>
                <th>Negeren</th>
                <th>Herstellen</th>
            </tr>
            <tbody id="tabelInhoud">
            </tbody>
        </table>
    </div>
    {% if storingen|length > 30 %}
        <div class="center-align">
            <a class="waves-effect waves-light btn-large grey lighten-2 black-text" href="{% url 'alle_storingen'%}"><i class="material-icons left ">more_vert</i>Alle storingen</a>
        </div>
    {% endif %}
{% endblock content%}

{% block javascript%}
    <script>
        function swalDeactiveerStoring(id){
            Swal.fire({
                title: 'Zeker weten?',
                text: "De storing wordt nu afgesloten. Bij nieuwe updates word een nieuwe storing aangemaakt.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ja, Herstel!'
              }).then((result) => {
                if (result.value) {
                        window.location = "/tram/storing/"+ id +"/deactiveer";
                    }
                }
            )
        }

        function getAjaxData(){
            $.ajax({
                method: "GET",
                url: "tram/api/alle_actieve_storingen",
                success: function(response){
                    updateTabel(response)
                },
                error: function(error_data){
                    console.log(error_data)
                },
            })
        }

        function updateTabel(data){
            $('#balk').hide();

            var inhoud = ""
            var omloop_cel
            for (storing of data){
                if (storing.laatste_data__omloop_b > 0) { omloop_cel = `<td>A:${storing.laatste_data__omloop_a} <br> B: ${storing.laatste_data__omloop_b}</td>`} else {omloop_cel = `<td>${storing.laatste_data__omloop_a}</td>`}
                regel = '<tr>' +
                `<td><label><input name="geselecteerde_storingen" value="${storing.id}" type="checkbox" class="filled-in"/><span></span></label></td>` +
                `<td>${storing.id}</td>`+
                `<td><a href="/tram/asset/${storing.laatste_data__assetnummer__assetnummer}">${storing.laatste_data__assetnummer__assetnummer}</a></td>` +
                `<td>${storing.bericht}</td>` +
                `<td>${storing.som}</td>` +
                `<td>${storing.score}</td>` +
                omloop_cel +
                `<td>${storing.laatste_data__tijdstip}</td>` +
                `<td><a href="storing/${storing.id}/gezien"><i class="material-icons small">visibility_off</i></a></td>` +
                `<td><a href="#" onclick="swalDeactiveerStoring('${storing.id}}')"><i class="material-icons small red-text">offline_pin</i></a></td>`
                inhoud += regel
            }
            $('#tabelInhoud').html(inhoud);
            console.log("refresh");
            $('#balk').show();
        }

        $(document).ready(function(){
          $("#zoekBalk").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            document.getElementById("afteller").style.animationPlayState = "paused";
            document.getElementById("zbIcon").style.animationPlayState = "paused";
            document.getElementById("zoekBalk").style.animationPlayState = "paused";
            $("#tabelInhoud tr").filter(function() {
              $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
            if (value == ""){
                document.getElementById("afteller").style.animationPlayState = "running";
                document.getElementById("zbIcon").style.animationPlayState = "running";
                document.getElementById("zoekBalk").style.animationPlayState = "running";
            }
          });

          getAjaxData();
          document.getElementById("afteller").addEventListener("animationiteration", getAjaxData);

        });
    </script>
{% endblock javascript%}