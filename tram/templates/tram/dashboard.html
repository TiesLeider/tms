{% extends "tram/base.html" %}
{%block head %}
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
{%endblock%}
{% block content %}
<div class="card-panel white">
    <h1>Dashboard</h1>
    <div class="row">
        <div class="input-field col s6">
            <input id="van_datum" type="text" class="datepicker">
            <label for="van_datum">Vanaf datum</label>
        </div>
        <div class="input-field col s5">
            <input id="tot_datum" type="text" class="datepicker">
            <label for="tot_datum">Tot en met datum</label>
        </div>
    </div>
    <div class="row">
        <h4 id="datumText">Alle data tot vandaag.</h4>
    </div>
    <div class="row">
        <div class="col s12 m6 l6">
            <div class="card-panel white">
                <figure class="highcharts-figure">
                    <div id="omlopen"></div>
                    <p class="highcharts-description">
                    </p>
                </figure>
            </div>
        </div>
        {% for storing in storingen %}
        <div class="col s12 m6 l6">
            <div class="card-panel white">
                <figure class="highcharts-figure">
                    <div id="{{storing}}"></div>
                    <p class="highcharts-description">
                    </p>
                </figure>
            </div>
        </div>
        {% endfor %}
        <div class="col s12 m12 l12">
            <div class="card-panel white">
                <figure class="highcharts-figure">
                    <div id="container" style="height: 600px;"></div>
                    <p class="highcharts-description">
                    </p>
                </figure>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript"> 
    const storingen = JSON.parse("{{storingen_serz|escapejs}}");
    const druk_assets = JSON.parse("{{druk_assets_serz|escapejs}}");
 </script>
{% endblock %}
{% block javascript %}  

<script>
    $(document).ready(function() {
        var vanDatumPicker = $('#van_datum').datepicker({
            maxDate: new Date(),
            format: "dd-mm-yyyy",
            onClose: function () {
                for (s of storingen){
                    getAjaxDataTimerange(storingType=s);
                }
            }
        });

        var totDatumPicker = $('#tot_datum').datepicker({
            maxDate: new Date(),
            defaultDate: new Date(),
            setDefaultDate: true,
            format: "dd-mm-yyyy",
            onClose: function () {
                for (s of storingen){
                    getAjaxDataTimerange(storingType=s);
                }
            }
        });

    });

    function getAjaxData(){
        $.ajax({
            method: "GET",
            url: "/tram/api/dashboard_omlopen",
            success: function(response){
                highchartOmlopen(response)
            },
            error: function(error_data){
                console.log(error_data)
            },
        })
    }

    function getAjaxDataStoring(storing){
        $.ajax({
            method: "GET",
            url: `/tram/api/dashboard/storing/${storing}`,
            success: function(response){
                highchartStoring(response, storing)
                console.log(response)
            },
            error: function(error_data){
                console.log(error_data)
            },
        })
    }

    function highchartOmlopen(data){
        Highcharts.chart('omlopen', {
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: 'Omlopen',
            },
            subtitle:{
                text: `Totaal aantal omlopen alle assets: ${data.totale_omlopen}`
            },
            tooltip: {
                pointFormat: '<b>{point.percentage:.1f}% (= {point.omlopen} omlopen)</b>'
            },
            accessibility: {
                point: {
                    valueSuffix: '%'
                }
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                    }
                }
            },
            series: [{
                name: 'Assets',
                colorByPoint: true,
                data: data.asset_array
            }]
        });
    }

    function highchartStoring(data, storing){
        Highcharts.chart(`${storing}`, {
            chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                type: 'pie'
            },
            title: {
                text: `${storing}`,
            },
            subtitle:{
                text: `Totaal aantal storingen alle assets: ${data.totale_storingen}`
            },
            tooltip: {
                pointFormat: '<b>{point.percentage:.1f}%</b>'
            },
            accessibility: {
                point: {
                    valueSuffix: '%'
                }
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: true,
                        format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                    }
                }
            },
            series: [{
                name: 'Assets',
                colorByPoint: true,
                data: data.asset_array
            }]
        });
    }

    getAjaxData();
    
    for (s of storingen){
        getAjaxDataStoring(s);
    }
    
    function getAjaxDataTimerange(storingType, vanDatum = document.getElementById("van_datum").value, totDatum = document.getElementById("tot_datum").value) {
        $.ajax({
            method: "GET",
            url: `/tram/api/dashboard/storing/${storingType}/${vanDatum}/${totDatum}`,
            success: function (response) {
                highchartStoring(response, storingType)
            },
            error: function (error_data) {
                console.log(error_data)
            }
        })

        $.ajax({
            method: "GET",
            url: `/tram/api/dashboard_omlopen/${vanDatum}/${totDatum}`,
            beforeSend: function () {
                $("#datumText").text(`Laden...`)
            },
            success: function (response) {
                highchartOmlopen(response)
            },
            error: function (error_data) {
                console.log(error_data)
            },
            complete: function(){
                $("#datumText").text(`Data van ${vanDatum} tot en met ${totDatum}`)

            }
        })

    }

    var seriesOptions = [],
    seriesCounter = 0,
    names = [];
    for (druk_asset of druk_assets){
        names.push(druk_asset["assetnummer"] +" - " + druk_asset["veld"])
    }

function createChart() {

    Highcharts.stockChart('container', {

        legend: {
            enabled: true,
            align: 'right',
            backgroundColor: '#FCFFC5',
            borderColor: 'black',
            borderWidth: 2,
            layout: 'vertical',
            verticalAlign: 'top',
            y: 100,
            shadow: true
        },
        rangeSelector: {
            selected: 4
        },
        tooltip: {
            valueDecimals: 2,
            split: false
        },

        series: seriesOptions
    });
}

function success(data) {
    var urlpatern = this.url.split("/")
    console.log(urlpatern)
    var name = urlpatern[4].toUpperCase() + " - " + urlpatern[5];
    var i = names.indexOf(name);
    seriesOptions[i] = {
        name: name,
        data: data
    };

    // As we're loading the data asynchronously, we don't know what order it
    // will arrive. So we keep a counter and create the chart when all the data is loaded.
    seriesCounter += 1;

    if (seriesCounter === names.length) {
        createChart();
    }
}

for (druk_asset of druk_assets){
    Highcharts.getJSON(
    `/tram/api/get_sensor_waarden/${druk_asset["assetnummer"]}/${druk_asset["veld"]}`,
    success
);
}
</script>
{% endblock %}